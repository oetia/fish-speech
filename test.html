<html>

<head>

</head>

<body>

  <input id="tts-input" type="text" placeholder="Enter text for TTS">
  <button id="tts-button">Generate TTS</button>

  <script>

    async function streamTTS(text) {
      const response = await fetch('/tts/stream', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (!response.ok) {
        throw new Error('Failed to fetch TTS stream');
      }

      const reader = response.body.getReader();
      return reader;
    }

    async function playTTS(text) {
      const audioContext = new AudioContext({ sampleRate: 16000 }); // Match server sample rate
      let nextStartTime = audioContext.currentTime; // Track playback time
      const reader = await streamTTS(text);

      async function processChunk() {
        const { value, done } = await reader.read();
        if (done) {
          console.log('Stream complete');
          await audioContext.close();
          return;
        }

        // Decode .wav chunk
        const audioBuffer = await audioContext.decodeAudioData(value.buffer);
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);

        // Schedule playback
        source.start(nextStartTime);
        nextStartTime += audioBuffer.duration; // Schedule next chunk

        // Process next chunk
        await processChunk();
      }

      await processChunk();
    }

    // Example usage
    document.getElementById('tts-button').addEventListener('click', () => {
      const text = document.getElementById('tts-input').value;
      playTTS(text).catch(console.error);
    });
  </script>
</body>

</html>